# application-dev.yaml.example â€” ArgoCD Application for the dev environment.
#
# This manifest tells ArgoCD to watch the SnapEnv GitHub repository
# and automatically deploy the Helm chart into a dedicated namespace.
#
# ArgoCD continuously compares the desired state (this file + the Helm chart
# in the repo) with the actual state (what's running in the cluster).
# If they diverge, ArgoCD reconciles automatically (selfHeal + prune).
#
# Copy this file, fill in your credentials, and apply manually:
#   cp application-dev.yaml.example application-dev.yaml
#   # edit application-dev.yaml with real values
#   kubectl apply -f infra/argocd/application-dev.yaml
#
# For production, this parameters block should be replaced entirely
# by Sealed Secrets or External Secrets Operator (see secret.yaml
# in the Helm chart for the full DevSecOps progression).

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: snapenv-dev
  namespace: argocd        # ArgoCD Applications always live in the argocd namespace
spec:
  project: snapenv          # References the AppProject defined in project.yaml

  source:
    repoURL: 'https://github.com/robin-replat/SnapEnv.git'
    targetRevision: HEAD    # Track the latest commit on default branch
    path: infra/helm/snapenv  # Path to the Helm chart inside the repo
    helm:
      valueFiles:
        - values.yaml       # Base values (no secrets, committed to Git)
      parameters:
        # Override credentials at deploy time.
        # Replace REPLACE_ME with actual values before applying.
        - name: postgresql.auth.username
          value: "REPLACE_ME"
        - name: postgresql.auth.password
          value: "REPLACE_ME"
        - name: postgresql.auth.database
          value: "REPLACE_ME"

  destination:
    server: 'https://kubernetes.default.svc'  # Deploy to the local cluster
    namespace: snapenv-dev   # Dedicated namespace for this environment

  syncPolicy:
    automated:
      prune: true       # Delete K8s resources that are no longer in Git
      selfHeal: true    # Revert manual changes made directly to the cluster
    syncOptions:
      - CreateNamespace=true  # Create the namespace if it doesn't exist
